<template>
  <div class="information-detail-wrap">
    <div class="container">
      <groupTitle class="g-title" :bordered="false">
        <template #title>
          <div>
            <!-- <a-link
              type="text"
              size="small"
              class="back-btn"
              @click="handleBack"
              >{{ $t('common.button.back') }}</a-link
            >
            <a-divider direction="vertical" class="divider"></a-divider> -->
            <span>{{ $t('vulnerability.detail.title') }}</span>
          </div>
        </template>
      </groupTitle>
      <a-card
        class="general-card q-s-w-card"
        :bordered="false"
        style="margin-bottom: 10px"
      >
        <a-descriptions
          :title="$t('vulnerability.detail.basic')"
          :data="dataList"
          :column="2"
          layout="inline-horizontal"
          class="basic-desc"
        >
          <template #label="{ label }"
            ><span>{{ $t(label) }}</span></template
          >
          <template #value="{ value, data }">
            <span v-if="data.key === 'purl'" class="basic-val val">
              {{
                get(data.packageInfo, 'namespace')
                  ? `${get(data.packageInfo, 'namespace')}/${get(
                      data.packageInfo,
                      'name'
                    )}`
                  : `${get(data.packageInfo, 'name')}`
              }}
              <span class="type">{{
                get(data.packageInfo, 'qualifiers.distro')
                  ? `(${get(data.packageInfo, 'type')}/${get(
                      data.packageInfo,
                      'qualifiers.distro'
                    ).replace('-', ':')})`
                  : `(${get(data.packageInfo, 'type')})`
              }}</span>
            </span>
            <span v-else-if="data.key === 'affected'" class="basic-val">
              <span class="affected-val">{{ value }}</span>
            </span>
            <span v-else-if="data.key === 'name'">
              <span class="vulner-name"
                >{{ value
                }}<span class="type" style="vertical-align: 2px"
                  >{{ `(${data.namespace})`
                  }}<a-tag
                    v-if="data.deprecated"
                    style="margin-left: 4px; color: #f77234"
                    color="rgba(247, 114, 52,.2)"
                    size="small"
                    >{{ $t('license.tablist.deprecated') }}</a-tag
                  ></span
                >
              </span>
            </span>
            <span v-else class="basic-val val">{{
              value ? value : $t('vulnerability.list.fix.no')
            }}</span>
          </template>
        </a-descriptions>
      </a-card>
      <a-card class="general-card q-s-w-card content" :bordered="false">
        <div>
          <a-row class="info" :gutter="15">
            <a-col :span="16">
              <div class="desc">
                <div class="desc-title">Description</div>
                <div class="custom-md" v-html="description"> </div>
                <div v-show="get(detailInfo, 'mitigation')" class="desc-title"
                  >Mitigation</div
                >
                <div class="text">{{ get(detailInfo, 'mitigation') }}</div>
                <div v-show="get(detailInfo, 'exploitation')" class="desc-title"
                  >Exploitation</div
                >
                <div class="custom-md" v-html="exploitation"> </div>
                <div v-if="references?.length" class="desc-refs">
                  <div class="desc-title">References</div>
                  <ul class="refs-wrap">
                    <li v-for="link in references" :key="link">
                      <a-link :href="link" target="_blank">{{ link }}</a-link>
                    </li>
                  </ul>
                </div>
              </div>
            </a-col>
            <a-col :span="8">
              <div v-if="get(detailInfo, 'cvss.vectorString')">
                <div class="chart">
                  <Chart
                    style="width: 100%; height: 260px"
                    :option="chartOptions"
                  />
                  <div v-if="get(detailInfo, 'cvss.baseSeverity')" class="s-box"
                    ><span
                      class="severity"
                      :class="[lowerCase(get(detailInfo, 'cvss.baseSeverity'))]"
                      >{{
                        capitalize(get(detailInfo, 'cvss.baseSeverity'))
                      }}</span
                    ></div
                  >
                </div>
                <div class="sl-info cvss">
                  <div class="value">{{
                    get(detailInfo, 'cvss.vectorString')
                  }}</div>
                </div>
              </div>
              <div class="cvss-info">
                <a-descriptions
                  v-if="cvssDataList.length"
                  layout="vertical"
                  :value-style="{
                    'text-align': 'center',
                    'padding': 0,
                    'color': '#fff',
                  }"
                  :label-style="{ 'text-align': 'center' }"
                  :data="cvssDataList"
                  :column="2"
                  :title="$t('vulnerability.detail.cvss.title')"
                >
                  <template #value="{ value, data }">
                    <div :style="{ background: data.color }">{{
                      $t(value)
                    }}</div>
                  </template>
                  <template #label="{ data }">
                    <span>{{ $t(data.localeLabel) }}</span>
                  </template>
                </a-descriptions>
              </div>
              <div v-if="!get(detailInfo, 'cvss.vectorString')" class="sl-info">
                <span class="title">CVSS</span>
                <div class="value">{{ $t('common.data.none') }}</div>
              </div>
              <div
                v-if="
                  get(detailInfo, 'cvss.baseSeverity') &&
                  get(detailInfo, 'cvss.baseSeverity') !== 'NONE' &&
                  !get(detailInfo, 'cvss.vectorString')
                "
                class="sl-info"
              >
                <span class="title">{{
                  $t('vulnerability.detail.cvss.severity')
                }}</span>
                <div class="value"
                  ><span
                    class="severity"
                    :class="[lowerCase(get(detailInfo, 'cvss.baseSeverity'))]"
                    >{{
                      capitalize(get(detailInfo, 'cvss.baseSeverity'))
                    }}</span
                  ></div
                >
              </div>
              <div v-if="!get(detailInfo, 'cvss.vectorString')" class="sl-info">
                <span class="title">{{
                  $t('vulnerability.detail.cvss.severity')
                }}</span>
                <div class="value">{{ $t('common.data.unkonwn') }}</div>
              </div>
              <div class="sl-info">
                <span class="title"
                  >EPSS
                  <a-tooltip :content="$t('vulnerability.detail.epss.tips')">
                    <icon-question-circle />
                  </a-tooltip>
                </span>
                <div v-if="get(detailInfo, 'epss.score') > 0" class="value">{{
                  `${round(get(detailInfo, 'epss.score') * 100, 2)}%`
                }}</div>
                <div v-else class="value">{{ $t('common.data.none') }}</div>
              </div>
              <div class="sl-info">
                <span class="title">{{
                  $t('vulnerability.detail.cvss.weaknesses')
                }}</span>
                <div v-if="get(detailInfo, 'cwes')?.length" class="value">
                  <a-link
                    v-for="link in get(detailInfo, 'cwes') || []"
                    :key="link"
                    class="cwe-link"
                    target="_blank"
                    :href="getCweLink(link)"
                    >{{ link }}</a-link
                  >
                </div>
                <div v-else class="value">{{ $t('common.data.unkonwn') }}</div>
              </div>
              <div class="sl-info">
                <span class="title">CVE</span>
                <div v-if="get(detailInfo, 'tags')?.length" class="value">
                  <a-link
                    v-for="link in get(detailInfo, 'tags') || []"
                    :key="link"
                    class="cwe-link"
                    target="_blank"
                    :href="getCveLink(link)"
                    >{{ link }}</a-link
                  >
                </div>
                <div v-else class="value">{{ $t('common.data.unkonwn') }}</div>
              </div>
              <div class="sl-info">
                <span class="title">Seal Code</span>
                <div class="value">{{ get(detailInfo, 'code') }}</div>
              </div>
            </a-col>
          </a-row>
        </div>
      </a-card>
    </div>
  </div>
</template>

<script lang="ts" setup>
  import {
    get,
    join,
    lowerCase,
    capitalize,
    split,
    round,
    isNaN,
  } from 'lodash';
  import { PackageURL } from 'packageurl-js';
  import MarkdownIt from 'markdown-it';
  import groupTitle from '@/components/group-title/index.vue';
  import { onMounted, ref, computed, onBeforeMount } from 'vue';
  import { useRoute, useRouter } from 'vue-router';
  import useChartOption from '@/hooks/chart-option';
  import { basicInfoConfig, severityColor, cvssConfigItem } from '../config';
  import { queryDataDetail } from '../api';
  import useParseCvss from '../hooks/use-parse-cvss';

  const route = useRoute();
  const router = useRouter();
  const md = new MarkdownIt();
  const chartOptions = ref<unknown>({});
  const references = ref<string[]>([]);
  const cvssDataList = ref<cvssConfigItem[]>([]);
  const { parseCvssScore } = useParseCvss();
  const description = ref('');
  const exploitation = ref('');
  const detailInfo = ref({
    description: '',
    namespace: '',
  });
  const dataList = ref<{ label: string; value: string }[]>([]);
  const setBasicInfo = () => {
    dataList.value = basicInfoConfig.map((item) => {
      const val = get(detailInfo.value, item.key);
      if (item.key === 'purl') {
        console.log('packageinfo===', PackageURL.fromString(val));
      }
      return {
        label: item.label,
        key: item.key,
        span: item.span || 1,
        namespace: detailInfo.value.namespace,
        packageInfo: item.key === 'purl' ? PackageURL.fromString(val) : '',
        value: item.key === 'patched' ? join(val, ',') : val,
        deprecated: get(detailInfo.value, 'deprecated'),
      };
    });
  };
  const ordinalNumber = (number) => {
    const n = round(number * 100);
    if (isNaN(n)) {
      return 0;
    }
    return n + (['st', 'nd', 'rd'][n < 20 ? n - 1 : (n % 10) - 1] || 'th');
  };
  const getCvssBasicIndex = () => {
    cvssDataList.value = parseCvssScore({
      version: get(detailInfo.value, 'cvss.version'),
      vector: get(detailInfo.value, 'cvss.vectorString'),
    });
    console.log('dataindex===', cvssDataList.value);
  };
  const fetchData = async () => {
    try {
      const { id } = route.query;
      const { data } = await queryDataDetail(id);
      detailInfo.value = Object.assign(detailInfo.value, data);
      setBasicInfo();
      getCvssBasicIndex();
    } catch (error) {
      console.log(error);
    }
  };
  const getMarkDesc = () => {
    const reg = /#{1,4}\s+References[^#]+[#]{1,4}/i;
    references.value = get(detailInfo.value, 'references') || [];
    let desc =
      get(detailInfo.value, 'description') ||
      get(detailInfo.value, 'summary') ||
      '';
    desc = desc.replace(reg, '\n\n###');
    const exploit = get(detailInfo.value, 'exploitation') || '';
    description.value = md.render(desc);
    exploitation.value = md.render(exploit);
  };
  const getCweLink = (link) => {
    const list = split(link, '-');
    return `https://cwe.mitre.org/data/definitions/${get(list, '1')}.html`;
  };
  const getCveLink = (link) => {
    return `https://cve.mitre.org/cgi-bin/cvename.cgi?name=${link}`;
  };
  const setChartOptions = () => {
    const { chartOption } = useChartOption(() => {
      const score = get(detailInfo.value, 'cvss.baseScore');
      const severity = get(detailInfo.value, 'cvss.baseSeverity') || 'none';
      return {
        series: [
          {
            center: ['50%', '50%'],
            radius: '100%',
            max: 10,
            type: 'gauge',
            progress: {
              show: true,
              width: 8,
            },
            axisLine: {
              lineStyle: {
                width: 8,
              },
            },
            axisTick: {
              show: false,
            },
            splitLine: {
              length: 10,
              distance: 2,
              lineStyle: {
                width: 1,
                color: '#999',
              },
            },
            itemStyle: {
              color: severityColor[lowerCase(severity)],
            },
            axisLabel: {
              distance: 12,
              color: '#999',
              fontSize: 18,
            },
            anchor: {
              show: false,
              showAbove: true,
              size: 5,
              itemStyle: {
                borderWidth: 5,
                color: severityColor[lowerCase(severity)],
              },
            },
            title: {
              show: false,
            },
            detail: {
              valueAnimation: false,
              fontSize: 28,
              offsetCenter: [0, '70%'],
            },
            data: [
              {
                value: score,
              },
            ],
          },
        ],
      };
    });
    chartOptions.value = chartOption.value;
    console.log('chartOption:', chartOptions.value, chartOption);
  };
  const handleBack = () => {
    console.log('back');
    router.back();
  };
  onMounted(async () => {
    await fetchData();
    getMarkDesc();
    setChartOptions();
  });
</script>

<style lang="less">
  @import url('@/assets/style/custom-md.less');
</style>

<style lang="less" scoped>
  .information-detail-wrap {
    min-width: 800px;
    max-width: 1440px;
    margin: 0 auto;

    :deep(.arco-descriptions-title) {
      font-size: 14px;
    }

    .g-title {
      margin-bottom: 10px;
      border-bottom: 1px solid #fff;

      .arco-link {
        line-height: 1;
      }

      .divider {
        border-left: 1px solid var(--color-neutral-3);
      }
    }

    .basic-desc {
      :deep(.arco-descriptions-body) {
        padding: 0;
        background-color: var(--color-fill-1);
        border: none;
        border-radius: var(--border-radius-medium);

        .arco-descriptions-table {
          border-collapse: separate;
          border-spacing: 10px;
        }

        .arco-descriptions-item-label {
          // margin-right: 10px;
        }

        .arco-descriptions-item-label-block {
          padding-right: 10px;
        }

        .arco-descriptions-item {
          // background: #fff;
          padding: 0 10px;
          border-radius: var(--border-radius-medium);
        }
      }
    }

    .container {
      margin-top: 20px;

      :deep(.arco-card-body) {
        padding: 20px 20px 20px 20px;
      }

      .content {
        :deep(.arco-card-body) {
          padding-bottom: 40px;
        }
      }

      .basic-val {
        font-weight: 500;

        &.val {
          display: inline-block;
          padding: 0 10px;
          word-break: break-all;
        }

        .affected-val {
          padding: 0 10px;
          word-break: break-all;
        }
      }

      .vulner-name {
        font-weight: 500;
        font-size: 24px;
      }

      .type {
        color: var(--color-text-3);
      }

      .info {
        .desc {
          box-sizing: border-box;
          padding: 20px;
          border: 1px solid var(--color-neutral-3);
          border-radius: var(--border-radius-medium);

          .text {
            margin: 20px 0;
          }

          .desc-title {
            color: var(--color-text-2);
            font-weight: 700;
            font-size: 16px;
          }
        }

        .cvss-info {
          box-sizing: border-box;
          // padding: 10px;
          // border: 1px solid var(--color-neutral-3);
          // border-radius: var(--border-radius-medium);
          :deep(.arco-descriptions-item-label) {
            background-color: var(--color-fill-2);
          }

          :deep(.arco-descriptions-item-value-block) {
            padding-bottom: 8px !important;
            // height: 30px;
          }

          :deep(.arco-descriptions-table) {
            border-collapse: separate;
            border-spacing: 6px 0;
          }
        }
      }

      .refs-wrap {
        :deep(.arco-link) {
          justify-content: flex-start;
          width: 100%;
          word-break: break-all;
        }
      }

      :deep(.arco-link) {
        &.cwe-link {
          margin-right: 8px;
          margin-bottom: 5px;
          font-size: 12px;
          border: 1px solid rgb(var(--link-6));
          border-radius: 14px;
        }
      }

      .sl-info {
        margin-top: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--color-neutral-3);

        &.cvss {
          font-weight: 500;
          text-align: center;
          border: none;
        }

        .title {
          font-weight: 500;
          font-size: 14px;
        }

        .value {
          margin-top: 20px;
        }
      }

      .severity {
        padding: 3px 6px;
        font-size: 14px;
        border: 1px solid #e5e6eb;
        border-radius: 4px;

        &.critical {
          color: #f53f3f;
          border: 1px solid #f53f3f;
        }

        &.high {
          color: #f77234;
          border: 1px solid #f77234;
        }

        &.medium {
          color: #f7ba1e;
          border: 1px solid #f7ba1e;
        }

        &.low {
          color: #9fdb1d;
          border: 1px solid #9fdb1d;
        }

        &.none {
          color: #e5e6eb;
          border: 1px solid #e5e6eb;
        }
      }

      .chart {
        .s-box {
          margin-bottom: 20px;
          line-height: 2;
          text-align: center;
        }
      }
    }
  }
</style>
